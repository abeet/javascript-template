<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Cache-Control" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>Console</title>
<link rel="stylesheet" type="text/css" href="resource/css/els.css"/>
<script type="text/javascript" src="resource/js/els.js"></script>
<script type="text/javascript">
//<![CDATA[

var Cursor = function(object){
    this.object = object;
};

Cursor.prototype.getPosition = function(){
    var object = this.object;
    var data = {text: "", start: 0, end: 0};
    try{object.focus();}catch(e){}

    if(object.setSelectionRange)
    {
        data.start= object.selectionStart;
        data.end = object.selectionEnd;
        data.text = (data.start != data.end) ? object.value.substring(object.start, object.end): "";
    }
    else if(document.selection)
    {
        var i;
        var oS = document.selection.createRange();
        var oR = document.body.createTextRange();

        oR.moveToElementText(object);

        data.text = oS.text;
        data.bookmark = oS.getBookmark();

        for(i = 0; oR.compareEndPoints("StartToStart", oS) < 0 && oS.moveStart("character", -1) !== 0; i++)
        {
            if(object.value.charAt(i) == "/n")
            {
                i++;
            }
        }

        data.start = i;
        data.end = data.text.length + data.start;
    }

    object.setAttribute("cursorPosition", data.start);
    return data;
};

Cursor.prototype.setPosition = function(x, y){
    if(document.all)
    {
        var range = this.object.createTextRange();
        range.moveStart("character", x);
        range.moveEnd("character", y);
        range.collapse(true);
        range.select();
    }
    else
    {
        this.object.select();
        this.object.selectionStart = x;
        this.object.selectionEnd = y;
    }
};

Cursor.prototype.insert = function(object, text){
    if(object == null || text == null)
    {
        return;
    }

    try
    {
        object.focus();
    }
    catch(e)
    {
    }

    var selection = document.selection;

    if(object.selectionStart != null)
    {
        var start = object.selectionStart + 0;
        object.value = object.value.substring(0, start) + text + object.value.substring(object.selectionEnd);
        object.selectionStart = start + text.length;
        object.selectionEnd = start + text.length;
    }
    else if(selection && selection.createRange)
    {
        var cursorPosition = object.getAttribute("cursorPosition");

        if(cursorPosition != null)
        {
            var range = object.createTextRange();
            range.moveStart("character", parseInt(cursorPosition));
            range.moveEnd("character", parseInt(cursorPosition));
            range.collapse(true);
            range.select();
        }

        var range = selection.createRange();
        range.text = text;

        var getLength = function(s)
        {
            var userAgent = window.navigator.userAgent.toLowerCase();
            var isOpera = userAgent.indexOf("opera") != -1 && opera.version();
            var isIE = (userAgent.indexOf("msie") != -1 && !isOpera) && userAgent.substring(userAgent.indexOf("msie") + 5, 3);

            var length = (isIE && s.indexOf('\n') != -1) ? s.replace(/\r?\n/g, "_").length : s.length;
            return length;
        };

        var length = 0 - getLength(text);
        range.moveStart("character", length);
        this.getPosition(object);
    }
    else
    {
        object.value += text;
    }
};

Cursor.prototype.write = function(s){
    var value = this.object.value;
    var position = this.getPosition();
    var start = position.start;

    try
    {
        object.focus();
    }
    catch(e)
    {
    }

    var selection = document.selection;

    if(this.object.selectionStart != null)
    {
        this.object.selectionStart = start + 1;
        this.object.selectionEnd = start + s.length - 1;
    }
    else if(selection && selection.createRange)
    {
        var range = selection.createRange();
        range.moveToElementText(this.object);
        range.moveStart("character", start + 1);
        range.moveEnd("character", -1600);
        // range.moveEnd("character", start + s.length - value.length - 1);
        // range.collapse(true);
        range.select();

        alert(start + s.length - value.length - 1);
    }

    // this.insert(this.object, s);
};

var cursor = null;

/**
 * @Override
 */
E.prototype.baseX = 23;
E.prototype.baseY = 1;

/**
 * @Override
 */
E.prototype.create = function(score){
    this.clear();
    var pool = [
        "        #################################                                       ",
        "        #            #                  #                                       ",
        "        #            # Speed: 8888888888#                                       ",
        "        #            # Score: 8888888888#                                       ",
        "        #            #                  #                                       ",
        "        #            #                  #                                       ",
        "        #            #                  #                                       ",
        "        #            #                  #                                       ",
        "        #            # Next             #                                       ",
        "        #            # 1111             #                                       ",
        "        #            # 1111             #                                       ",
        "        #            # 1111             #                                       ",
        "        #            #                  #                                       ",
        "        #            #                  #                                       ",
        "        #            #                  #                                       ",
        "        #            #                  #                                       ",
        "        #            # Hurry up!        #                                       ",
        "        #            #                  #                                       ",
        "        #            #                  #                                       ",
        "        #################################                                       "
    ];

    document.getElementById("mytextarea").value = pool.join("\r\n");

    this.setSpeed(0);
    this.setScore(0);
    this.info("Hurry up !");
};

/**
 * @Override
 */
E.prototype.clear = function(){
    for(var i = 1; i <= 25; i++)
    {
        cursor.setPosition(1, i);
        cursor.write("                                                                                ");
    }
};

/**
 * @Override
 */
E.prototype.setSpeed = function(speed){
    cursor.setPosition(this.baseX + 15, this.baseY + 2);
    cursor.write("                 ");
    cursor.setPosition(this.baseX + 15, this.baseY + 2);
    cursor.write("Speed: " + speed);
};

/**
 * @Override
 */
E.prototype.setScore = function(score){
    cursor.setPosition(this.baseX + 15, this.baseY + 3);
    cursor.write("                 ");
    cursor.setPosition(this.baseX + 15, this.baseY + 3);
    cursor.write("Score: " + score);
};

/**
 * @Override
 */
E.prototype.info = function(text){
    cursor.setPosition(this.baseX + 15, this.baseY + 16);
    cursor.write("                 ");
    cursor.setPosition(this.baseX + 15, this.baseY + 16);
    cursor.write(text);
};

/**
 * @Override
 */
E.prototype.copy = function(i, j){
    var ri = this.toBinaryString(this.p[i]);
    var rj = this.toBinaryString(this.p[j]);
    cursor.setPosition(this.baseX + 1, this.baseY + i + 1);
    cursor.write(ri.substring(3, 15).replace(/0/g, " ").replace(/1/g, "\1"));
    cursor.setPosition(this.baseX + 1, this.baseY + j + 1);
    cursor.write(rj.substring(3, 15).replace(/0/g, " ").replace(/1/g, "\1"));
};

/**
 * @Override
 */
E.prototype.setVisible = function(i, j, color){
    cursor.setPosition(this.baseX + j + 1, this.baseY + i + 1);

    if(color == this.bgcolor)
    {
        cursor.write(" ");
    }
    else
    {
        cursor.setColor(color);
        cursor.write("\1");
    }
};

/**
 * @Override
 */
E.prototype.setNextVisible = function(i, j, color, text){
    cursor.setPosition(this.baseX + j + 15, this.baseY + i + 9);

    if(color == this.bgcolor)
    {
        cursor.write(" ");
    }
    else
    {
        cursor.setColor(color);
        cursor.write("\1");
    }
};

window.onload = function()
{
    var e = new E();
    e.colors = ["b1", "b2", "b3", "b4", "b5", "b6", "b7"];
    e.bgcolor = "b0";

    /*
    document.getElementById("Container").innerHTML = e.create("PoolTable", 18, 12);
    document.getElementById("NextBlockPool").innerHTML = e.create("NextTable", 4, 4);
    document.onkeydown = (function(target, method){
        return function(e){
            method.apply(target, [(e || window.event), 0]);
        };
    })(e, e.event);
    */

    cursor = new Cursor(document.getElementById("mytextarea"));
};

function test()
{
    var x = parseInt(document.getElementById("posX").value);
    var y = parseInt(document.getElementById("posY").value);
    cursor.setPosition(x, y);
    cursor.write("HaHaHa");
}
//]]>
</script>
</head>
<body>
<div>
</div>
<div>
    <input id="posX" type="text" style="width: 60px;" value="10"/>
    <input id="posY" type="text" style="width: 60px;" value="20"/>
    <input type="button" value="test" onclick="test()"/>
</div>
</body>
</html>
